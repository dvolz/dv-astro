let c,l=[],m=0,v=60,B=60,b=4,u=0,I,$,y=null,w=null,h=!1;function O(n,e,t,o,i){const r=new URL(window.location.href);r.searchParams.set("v",n),r.searchParams.set("start",e.toString()),r.searchParams.set("duration",t.toString()),o&&r.searchParams.set("bpm",o.toString()),i&&r.searchParams.set("timeSig",i.toString()),window.history.pushState({},"",r.toString())}function R(){const n=new URLSearchParams(window.location.search),e=n.get("v"),t=n.get("start"),o=n.get("duration"),i=n.get("bpm"),r=n.get("timeSig");if(e){const s=document.getElementById("videoUrl");s&&(s.value=e)}if(t){const s=document.getElementById("startTime");s&&(s.value=t)}if(o){const s=document.getElementById("duration");s&&(s.value=o)}if(i){const s=document.getElementById("bpm");s&&(s.value=i)}if(r){const s=document.getElementById("timeSignature");s&&(s.value=r)}e&&t&&o&&setTimeout(()=>{document.getElementById("loadVideo")?.click()},1e3)}function U(n){if(!n)return null;if(n.length===11&&!n.includes("/"))return n;const e=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const t of e){const o=n.match(t);if(o&&o[1])return o[1]}return null}function S(n){return n.toFixed(1)+"s"}function L(){const n=document.getElementById("bpm"),e=document.getElementById("beatInterval");if(n&&e){const t=parseFloat(n.value);t>0?(u=60/t,e.textContent=u.toFixed(3)):(u=0,e.textContent="0")}}function C(){const n=document.getElementById("timeSignature");n&&(b=parseInt(n.value))}function x(){const n=document.getElementById("timingNotes"),e=document.getElementById("jsonStatus"),t=document.getElementById("timingNotesLabel"),o=n.value.trim();if(!o)return l=[],e&&(e.className="json-status",e.style.display="none"),t&&(t.textContent="Timing Notes (JSON)"),!0;try{const i=JSON.parse(o);if(!Array.isArray(i))throw new Error("JSON must be an array");for(const r of i){if(typeof r.time!="number")throw new Error('Each note must have a "time" number property');if(!r.countTo&&typeof r.message!="string")throw new Error('Each note must have either "message" or "countTo" property');if(r.duration&&typeof r.duration!="number")throw new Error("Duration must be a number");if(r.countTo&&typeof r.countTo!="boolean")throw new Error("countTo must be a boolean")}return l=i.sort((r,s)=>r.time-s.time),M(),A(),e&&(e.className="json-status valid",e.textContent=`Valid JSON âœ“ (${l.length} notes)`),t&&(t.textContent="Timing Notes (JSON) âœ… Valid"),!0}catch(i){return e&&(e.className="json-status invalid",e.textContent=`Error: ${i.message}`),t&&(t.textContent="Timing Notes (JSON) ðŸ’£ Invalid"),!1}}function A(){const n=document.getElementById("markers");!n||!c||(n.innerHTML="",l.forEach(e=>{if(e.time>=m&&e.time<=B){const t=document.createElement("div");t.className="marker";const o=(e.time-m)/v*100;t.style.left=`${o}%`,t.title=`${S(e.time)}: ${e.countTo?"COUNT-TO":e.message}`,n.appendChild(t)}}))}function M(){const n=document.getElementById("notesList");if(!n)return;if(l.length===0){n.innerHTML="No notes loaded";return}n.innerHTML=l.map((t,o)=>{const i=t.color||"#E8A87C",r=`color-mix(in srgb, ${i}, transparent 85%)`;return`
		<div class="note-item" data-index="${o}" data-note-color="${i}" style="cursor: pointer; background-color: ${r};" title="Click to jump to time">
			<strong>${S(t.time)}</strong> - ${t.countTo?"ðŸŽµ COUNT-TO":t.message}
			${t.duration?` (${t.duration}s)`:""}
		</div>
	`}).join(""),n.querySelectorAll(".note-item").forEach(t=>{t.addEventListener("click",()=>{const o=parseInt(t.getAttribute("data-index")||"0"),i=l[o];if(c&&i){let r=i.time;if(i.countTo&&u>0){const s=u*b;r=Math.max(m,i.time-s)}c.seekTo(r,!0),T()}})})}function D(n){const e=document.getElementById("currentNote");if(!e)return;let t=!1;for(let o=0;o<l.length;o++){const i=l[o],r=document.querySelector(`[data-index="${o}"]`);if(i.countTo){if(u<=0){r?.classList.remove("active");continue}const s=u*b,f=i.time-s,a=n-f;if(a>=0&&a<s){const d=Math.floor(a/u)+1;if(d<=b){y!==o&&(y=o,r?.classList.add("active")),e.classList.add("active"),e.textContent=d.toString();const g=i.color||"#E8A87C";e.style.setProperty("--note-color",g),e.style.removeProperty("border-color"),e.parentElement&&(e.parentElement.style.backgroundColor=`color-mix(in srgb, ${g}, transparent 85%)`),d!==w&&(w=d,e.classList.remove("beat-pop"),e.classList.remove("downbeat"),e.offsetWidth,e.classList.add("beat-pop"),d===1&&e.classList.add("downbeat")),t=!0}}else r?.classList.remove("active");if(t)continue}if(i.message){let s=i.time,f=1/0;if(i.showAfterCountTo){for(let a=o-1;a>=0;a--)if(l[a].countTo&&l[a].time<=i.time){s=l[a].time;break}}for(let a=o+1;a<l.length;a++){const d=l[a];if(d.countTo&&u>0){const g=u*b;f=d.time-g;break}if(d.message){let g=d.time;if(d.showAfterCountTo){for(let p=a-1;p>=0;p--)if(l[p].countTo&&l[p].time<=d.time){g=l[p].time;break}}f=g;break}}if(n>=s&&n<f){if(y!==o){y=o,e.classList.add("active"),e.textContent=i.message;const a=i.color||"#E8A87C";e.style.setProperty("--note-color",a),e.style.removeProperty("border-color"),e.parentElement&&(e.parentElement.style.backgroundColor=`color-mix(in srgb, ${a}, transparent 85%)`),r?.classList.add("active")}t=!0}else r?.classList.remove("active")}}!t&&y!==null&&(y=null,w=null,e.classList.remove("active"),e.classList.remove("beat-pop"),e.classList.remove("downbeat"),e.textContent="No note active",e.style.removeProperty("--note-color"),e.style.removeProperty("border-color"),e.parentElement&&e.parentElement.style.removeProperty("background-color"))}function T(){if(!c||typeof c.getCurrentTime!="function")return;const n=c.getCurrentTime();if(n>=B){c.pauseVideo(),c.seekTo(m,!0);return}const e=document.getElementById("currentTime"),t=document.getElementById("totalTime");e&&(e.textContent=S(n)),t&&(t.textContent=S(B));const o=document.getElementById("scrubber");if(o){const i=(n-m)/v*100;o.value=Math.max(0,Math.min(100,i)).toString()}D(n)}function j(){document.getElementById("playBtn")?.removeAttribute("disabled"),document.getElementById("pauseBtn")?.removeAttribute("disabled"),document.getElementById("resetBtn")?.removeAttribute("disabled"),document.getElementById("scrubber")?.removeAttribute("disabled")}function k(){const n=document.getElementById("videoUrl"),e=document.getElementById("startTime"),t=document.getElementById("duration"),o=U(n.value);if(!o){alert("Please enter a valid YouTube video ID or URL");return}m=parseFloat(e.value)||0,v=parseFloat(t.value)||60,B=m+v,C(),L();const i=document.getElementById("bpm"),r=document.getElementById("timeSignature"),s=i.value?parseFloat(i.value):void 0,f=r.value?parseInt(r.value):void 0;O(o,m,v,s,f),x()&&(c?c.loadVideoById({videoId:o,startSeconds:m}):c=new window.YT.Player("player",{height:"100%",width:"100%",videoId:o,playerVars:{start:m,controls:1,modestbranding:1},events:{onReady:()=>{console.log("Player ready"),j(),A(),I=window.setInterval(T,100)},onStateChange:a=>{a.data===window.YT.PlayerState.PLAYING?I=window.setInterval(T,100):clearInterval(I)}}}))}function F(){document.getElementById("loadVideo")?.addEventListener("click",k),document.getElementById("playBtn")?.addEventListener("click",()=>c?.playVideo()),document.getElementById("pauseBtn")?.addEventListener("click",()=>c?.pauseVideo()),document.getElementById("resetBtn")?.addEventListener("click",()=>c?.seekTo(m,!0)),document.getElementById("loadExample")?.addEventListener("click",()=>{const t=document.getElementById("videoUrl"),o=document.getElementById("startTime"),i=document.getElementById("duration"),r=document.getElementById("bpm"),s=document.getElementById("timeSignature");t&&(t.value="uOm-ccnhrjk"),o&&(o.value="133"),i&&(i.value="70"),r&&(r.value="149"),s&&(s.value="3"),L(),C(),k()});const n=document.getElementById("toggleVideo");n&&n.addEventListener("click",()=>{const t=document.getElementById("playerWrapper");if(t){const o=t.style.display==="none";t.style.display=o?"block":"none",n.textContent=o?"â–² Hide Video":"â–¼ Show Video",n.classList.toggle("expanded",o),requestAnimationFrame(()=>{E(),setTimeout(E,300)})}}),document.getElementById("timeSignature")?.addEventListener("change",C),document.getElementById("bpm")?.addEventListener("input",L),document.getElementById("validateJson")?.addEventListener("click",x),document.getElementById("timingNotes")?.addEventListener("input",()=>{clearTimeout(window.jsonValidationTimeout),window.jsonValidationTimeout=setTimeout(x,500)});const e=document.getElementById("scrubber");if(e){const t=o=>{if(c){const i=e.getBoundingClientRect(),r=(o.clientX-i.left)/i.width,s=m+r*v;c.seekTo(s,!0),T()}};e.addEventListener("mousedown",o=>{h=!0,clearInterval(I),t(o);const i=s=>{h&&t(s)},r=()=>{h=!1,document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",r),c&&c.getPlayerState()===window.YT.PlayerState.PLAYING&&(I=window.setInterval(T,100))};document.addEventListener("mousemove",i),document.addEventListener("mouseup",r)})}window.addEventListener("beforeunload",()=>{clearInterval(I),clearTimeout($)})}function E(){const n=document.querySelector(".notes-list"),e=document.querySelector(".player-section"),t=document.getElementById("playerWrapper"),o=document.querySelector(".timing-display");if(n&&e){let i=null;if(t&&t.style.display!=="none"?i=t:o&&(i=o),i){const r=i.getBoundingClientRect(),s=e.getBoundingClientRect(),f=r.top-s.top;n.style.marginTop=`${Math.max(0,f)}px`}}}const V=document.createElement("script");V.src="https://www.youtube.com/iframe_api";const N=document.getElementsByTagName("script")[0];N.parentNode?.insertBefore(V,N);window.onYouTubeIframeAPIReady=function(){console.log("YouTube API Ready")};function P(){R(),F(),E(),window.addEventListener("resize",E);const n=document.querySelector(".player-section");n&&new ResizeObserver(()=>{E()}).observe(n)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",P):P();
