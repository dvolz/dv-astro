let l,d=[],f=0,v=60,w=60,b=4,m=0,E,V,y=null,S=null,h=!1;function R(o,e,r,n,t){const i=new URL(window.location.href);i.searchParams.set("v",o),i.searchParams.set("start",e.toString()),i.searchParams.set("duration",r.toString()),n&&i.searchParams.set("bpm",n.toString()),t&&i.searchParams.set("timeSig",t.toString()),window.history.pushState({},"",i.toString())}function M(){const o=new URLSearchParams(window.location.search),e=o.get("v"),r=o.get("start"),n=o.get("duration"),t=o.get("bpm"),i=o.get("timeSig");if(e){const s=document.getElementById("videoUrl");s&&(s.value=e)}if(r){const s=document.getElementById("startTime");s&&(s.value=r)}if(n){const s=document.getElementById("duration");s&&(s.value=n)}if(t){const s=document.getElementById("bpm");s&&(s.value=t)}if(i){const s=document.getElementById("timeSignature");s&&(s.value=i)}e&&r&&n&&setTimeout(()=>{document.getElementById("loadVideo")?.click()},1e3)}function O(o){if(!o)return null;if(o.length===11&&!o.includes("/"))return o;const e=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const r of e){const n=o.match(r);if(n&&n[1])return n[1]}return null}function B(o){return o.toFixed(1)+"s"}function L(){const o=document.getElementById("bpm"),e=document.getElementById("beatInterval");if(o&&e){const r=parseFloat(o.value);r>0?(m=60/r,e.textContent=m.toFixed(3)):(m=0,e.textContent="0")}}function C(){const o=document.getElementById("timeSignature");o&&(b=parseInt(o.value))}function k(){const o=document.getElementById("timingNotes"),e=document.getElementById("jsonStatus"),r=document.getElementById("timingNotesLabel"),n=o.value.trim();if(!n)return d=[],e&&(e.className="json-status",e.style.display="none"),r&&(r.textContent="Timing Notes (JSON)"),!0;try{const t=JSON.parse(n);if(!Array.isArray(t))throw new Error("JSON must be an array");for(const i of t){if(typeof i.time!="number")throw new Error('Each note must have a "time" number property');if(!i.countTo&&typeof i.message!="string")throw new Error('Each note must have either "message" or "countTo" property');if(i.duration&&typeof i.duration!="number")throw new Error("Duration must be a number");if(i.countTo&&typeof i.countTo!="boolean")throw new Error("countTo must be a boolean")}return d=t.sort((i,s)=>i.time-s.time),U(),A(),e&&(e.className="json-status valid",e.textContent=`Valid JSON âœ“ (${d.length} notes)`),r&&(r.textContent="Timing Notes (JSON) âœ… Valid"),!0}catch(t){return e&&(e.className="json-status invalid",e.textContent=`Error: ${t.message}`),r&&(r.textContent="Timing Notes (JSON) ðŸ’£ Invalid"),!1}}function A(){const o=document.getElementById("markers");!o||!l||(o.innerHTML="",d.forEach(e=>{if(e.time>=f&&e.time<=w){const r=document.createElement("div");r.className="marker";const n=(e.time-f)/v*100;r.style.left=`${n}%`,r.title=`${B(e.time)}: ${e.countTo?"COUNT-TO":e.message}`,o.appendChild(r)}}))}function U(){const o=document.getElementById("notesList");if(!o)return;if(d.length===0){o.innerHTML="No notes loaded";return}o.innerHTML=d.map((r,n)=>{const t=r.color||"#E8A87C",i=`color-mix(in srgb, ${t}, transparent 70%)`;let s=r.time;if(r.countTo&&m>0){const a=m*b;s=r.time-a}else if(r.showAfterCountTo&&m>0){for(let a=n-1;a>=0;a--)if(d[a].countTo&&d[a].time<=r.time){s=d[a].time;break}}return`
		<div class="note-item" data-index="${n}" data-note-color="${t}" style="cursor: pointer; background-color: ${i};" title="Click to jump to time">
			<strong>${B(s)}</strong> - ${r.countTo?"ðŸŽµ COUNT-TO":r.message}
			${r.duration?` (${r.duration}s)`:""}
		</div>
	`}).join(""),o.querySelectorAll(".note-item").forEach(r=>{r.addEventListener("click",()=>{const n=parseInt(r.getAttribute("data-index")||"0"),t=d[n];if(l&&t){let i=t.time;if(t.countTo&&m>0){const s=m*b;i=Math.max(f,t.time-s)}l.seekTo(i,!0),T()}})})}function D(o){const e=document.getElementById("currentNote");if(!e)return;let r=!1;for(let n=0;n<d.length;n++){const t=d[n],i=document.querySelector(`[data-index="${n}"]`);if(t.countTo){if(m<=0){i?.classList.remove("active");continue}const s=m*b,a=t.time-s,c=o-a;if(c>=0&&c<s){const u=Math.floor(c/m)+1;if(u<=b){y!==n&&(y=n,i?.classList.add("active"),i instanceof HTMLElement&&i.style.setProperty("--note-color",t.color||"#E8A87C")),e.classList.add("active"),e.textContent=u.toString();const p=t.color||"#E8A87C";e.style.setProperty("--note-color",p),e.style.removeProperty("border-color"),e.parentElement&&(e.parentElement.style.backgroundColor=`color-mix(in srgb, ${p}, transparent 85%)`),u!==S&&(S=u,e.classList.remove("beat-pop"),e.classList.remove("downbeat"),e.offsetWidth,e.classList.add("beat-pop"),u===1&&e.classList.add("downbeat")),r=!0}}else i?.classList.remove("active");if(r)continue}if(t.message){let s=t.time,a=1/0;if(t.showAfterCountTo){for(let c=n-1;c>=0;c--)if(d[c].countTo&&d[c].time<=t.time){s=d[c].time;break}}for(let c=n+1;c<d.length;c++){const u=d[c];if(u.countTo&&m>0){const p=m*b;a=u.time-p;break}if(u.message){let p=u.time;if(u.showAfterCountTo){for(let g=c-1;g>=0;g--)if(d[g].countTo&&d[g].time<=u.time){p=d[g].time;break}}a=p;break}}if(o>=s&&o<a){if(y!==n){y=n,e.classList.add("active"),e.textContent=t.message;const c=t.color||"#E8A87C";e.style.setProperty("--note-color",c),e.style.removeProperty("border-color"),e.parentElement&&(e.parentElement.style.backgroundColor=`color-mix(in srgb, ${c}, transparent 85%)`),i?.classList.add("active"),i instanceof HTMLElement&&i.style.setProperty("--note-color",c)}r=!0}else i?.classList.remove("active")}}!r&&y!==null&&(y=null,S=null,e.classList.remove("active"),e.classList.remove("beat-pop"),e.classList.remove("downbeat"),e.textContent="No note active",e.style.removeProperty("--note-color"),e.style.removeProperty("border-color"),e.parentElement&&e.parentElement.style.removeProperty("background-color"))}function T(){if(!l||typeof l.getCurrentTime!="function")return;const o=l.getCurrentTime();if(o>=w){l.pauseVideo(),l.seekTo(f,!0);return}const e=document.getElementById("currentTime"),r=document.getElementById("totalTime");e&&(e.textContent=B(o)),r&&(r.textContent=B(w));const n=document.getElementById("scrubber");if(n){const t=(o-f)/v*100;n.value=Math.max(0,Math.min(100,t)).toString()}D(o)}function j(){document.getElementById("playBtn")?.removeAttribute("disabled"),document.getElementById("pauseBtn")?.removeAttribute("disabled"),document.getElementById("slowBtn")?.removeAttribute("disabled"),document.getElementById("resetBtn")?.removeAttribute("disabled"),document.getElementById("scrubber")?.removeAttribute("disabled")}function x(){const o=document.getElementById("videoUrl"),e=document.getElementById("startTime"),r=document.getElementById("duration"),n=O(o.value);if(!n){alert("Please enter a valid YouTube video ID or URL");return}f=parseFloat(e.value)||0,v=parseFloat(r.value)||60,w=f+v,C(),L();const t=document.getElementById("bpm"),i=document.getElementById("timeSignature"),s=t.value?parseFloat(t.value):void 0,a=i.value?parseInt(i.value):void 0;R(n,f,v,s,a),k()&&(l?l.loadVideoById({videoId:n,startSeconds:f}):l=new window.YT.Player("player",{height:"100%",width:"100%",videoId:n,playerVars:{start:f,controls:1,modestbranding:1},events:{onReady:()=>{console.log("Player ready"),j(),A(),E=window.setInterval(T,100)},onStateChange:c=>{c.data===window.YT.PlayerState.PLAYING?E=window.setInterval(T,100):clearInterval(E)}}}))}function F(){document.getElementById("loadVideo")?.addEventListener("click",x),document.getElementById("playBtn")?.addEventListener("click",()=>l?.playVideo()),document.getElementById("pauseBtn")?.addEventListener("click",()=>l?.pauseVideo());const o=document.getElementById("slowBtn");o?.addEventListener("click",()=>{if(l&&l.setPlaybackRate){const n=o.getAttribute("data-speed");let t,i;!n||n==="off"?(t="slow-1",i=.9):n==="slow-1"?(t="slow-2",i=.7):n==="slow-2"?(t="slow-3",i=.5):(t=null,i=1),l.setPlaybackRate(i),o.classList.remove("active","slow-1","slow-2","slow-3"),t?(o.setAttribute("data-speed",t),o.classList.add("active",t)):o.removeAttribute("data-speed");const s=document.getElementById("speedDisplay");s&&(i===1?s.textContent="":s.textContent=`${i}x`)}}),document.getElementById("resetBtn")?.addEventListener("click",()=>l?.seekTo(f,!0)),document.getElementById("loadExample")?.addEventListener("click",()=>{const n=document.getElementById("videoUrl"),t=document.getElementById("startTime"),i=document.getElementById("duration"),s=document.getElementById("bpm"),a=document.getElementById("timeSignature");n&&(n.value="uOm-ccnhrjk"),t&&(t.value="133"),i&&(i.value="70"),s&&(s.value="149"),a&&(a.value="3"),L(),C(),x()});const e=document.getElementById("toggleVideo");e&&e.addEventListener("click",()=>{const n=document.getElementById("playerWrapper");if(n){const t=n.style.display==="none";n.style.display=t?"block":"none",e.textContent=t?"â–² Hide Video":"â–¼ Show Video",e.classList.toggle("expanded",t),requestAnimationFrame(()=>{I(),setTimeout(I,300)})}}),document.getElementById("timeSignature")?.addEventListener("change",C),document.getElementById("bpm")?.addEventListener("input",L),document.getElementById("validateJson")?.addEventListener("click",k),document.getElementById("timingNotes")?.addEventListener("input",()=>{clearTimeout(window.jsonValidationTimeout),window.jsonValidationTimeout=setTimeout(k,500)});const r=document.getElementById("scrubber");if(r){const n=t=>{if(l){const i=r.getBoundingClientRect(),s=(t.clientX-i.left)/i.width,a=f+s*v;l.seekTo(a,!0),T()}};r.addEventListener("mousedown",t=>{h=!0,clearInterval(E),n(t);const i=a=>{h&&n(a)},s=()=>{h=!1,document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s),l&&l.getPlayerState()===window.YT.PlayerState.PLAYING&&(E=window.setInterval(T,100))};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)})}window.addEventListener("beforeunload",()=>{clearInterval(E),clearTimeout(V)})}function I(){const o=document.querySelector(".notes-list"),e=document.querySelector(".player-section"),r=document.getElementById("playerWrapper"),n=document.querySelector(".timing-display");if(o&&e){let t=null;if(r&&r.style.display!=="none"?t=r:n&&(t=n),t){const i=t.getBoundingClientRect(),s=e.getBoundingClientRect(),a=i.top-s.top;o.style.marginTop=`${Math.max(0,a)}px`}}}const $=document.createElement("script");$.src="https://www.youtube.com/iframe_api";const N=document.getElementsByTagName("script")[0];N.parentNode?.insertBefore($,N);window.onYouTubeIframeAPIReady=function(){console.log("YouTube API Ready")};function P(){M(),F(),I(),window.addEventListener("resize",I);const o=document.querySelector(".player-section");o&&new ResizeObserver(()=>{I()}).observe(o)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",P):P();
